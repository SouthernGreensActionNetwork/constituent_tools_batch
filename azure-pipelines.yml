# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

pool: PodmanAgents
variables:
  - name: containerPath
    value: sgan/containers/core
  - group: DigitalOcean
  - group: usvoters_pg
resources:
  containers:
    - container: constituent_tools
      image: registry.gitlab.com/sgan/containers/core/gulfcoastgreens/constituent_tools_container:latest
      endpoint: gl_registry
      # options: --dns 192.168.1.1
      env:
        PG_DATABASE: $(PG_DATABASE)
        PG_HOST: $(PG_HOST)
        PG_PASSWORD: $(PG_PASSWORD)
        PG_PORT: $(PG_PORT)
stages:
  - stage: openMySQLconnection
    displayName: Open MySQL connection to SGAN cluster
    jobs:
      - job: do_sgan_myssql_fwd
        pool: podman
        displayName: Forward Port to MySQL on SGAN-DO
        steps:
          - task: Docker@2
            inputs:
              containerRegistry: 'gl_registry'
              command: 'login'
            displayName: Login to registry    
          - task: Docker@2
            displayName: run
            inputs:
              containerRegistry: gl_registry
              repository: sgan/containers/core/jamjon3/kube_portforward_service:latest
              command: run
              arguments: --rm --name sganmysql --network=host -d registry.gitlab.com/sgan/containers/core/jamjon3/kube_portforward_service:latest
      - deployment: RunConstituentToolsBatch
        displayName: Run Constituent Tools Batch
        environment: digitalocean
        pool: PodmanAgents
        container: constituent_tools
        services:
          mysqlforward:
            image: registry.gitlab.com/sgan/containers/core/jamjon3/kube_portforward_service:latest
            endpoint: gl_registry
            # ports:
            # - localhost:3306:0.0.0.0:3306          
            env:
              DIGITALOCEAN_ACCESS_TOKEN: $(DIGITALOCEAN_ACCESS_TOKEN)
        strategy:
          runOnce:
            deploy:
              steps:
                - template: .template.yml
  - stage: closeMySQLconnection
    displayName: Close MySQL connection to SGAN cluster
    jobs:
      - job: do_sgan_myssql_fwd
        pool: podman
        displayName: Kill Forward Port to MySQL on SGAN-DO
        steps:
          - task: Docker@2
            inputs:
              containerRegistry: 'gl_registry'
              command: 'login'
            displayName: Login to registry    
          - task: Docker@2
            displayName: stop
            inputs:
              containerRegistry: gl_registry
              repository: sgan/containers/core/jamjon3/kube_portforward_service:latest
              command: stop
              arguments: sganmysql
